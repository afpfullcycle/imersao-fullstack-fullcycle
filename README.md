<p align="center">
    <img src="https://events-fullcycle.s3.amazonaws.com/events-fullcycle/static/site/img/grupo_4417.png" />
</p>

# Aulas Imersão FullStack FullCycle

## Aula 4

### Nest.js: Produtividade na era dos microserviços

```shell
cd ~/projects/imersao-fsfc/
npx @nestjs/cli new bank-api
code bank-api
npm start
npm install -g @nestjs/cli
nest generate controller controllers/my-first
```

- ./src/controller/my-first/my-first.controller.ts
  - Added route hello-world that return a JSON

```shell
npm run start:dev
```

>Browser
>>http://localhost:3000/my-first/hello-world

```shell
mkdir -p ./.docker/postgres ../node/app
touch ./Dockerfile ./docker-compose.yaml ./.docker/postgres/Dockerfile ./.docker/entrypoint.sh
chmod +x ./.docker/entrypoint.sh
```

- ./Dockerfile
  - Configured a image node alpine with nestjs-cli

- ./.docker/postgres/Dockerfile
  - Configured the postgres version and user id

- ./.docker/entrypoint.sh
  - Configured a instalation and start the npm

- ./docker-compose.yaml
  - Configured the app and db services
```

- ./tsconfig.json
  - Configured includ and exclude

```shell
rm -rf .dist node_modules
docker-compose up -d
```

>Browser
>>http://localhost:3000/my-first/hello-world

```shell
docker-compose exec app bash
npm install typeorm @nestjs/typeorm pg uuid --save
```

- ./package.json
  - Added the typeorm script

```shell
mkdir -p ./src/models/
touch ./.env
npm run typeorm migration:create -- -n CreateBankAccountsTable
```

- ./.env
  - Configured environment variable for database

- ./src/migrations/{id}-CreateBankAccountsTable.ts
  - Configured bank_accounts table

```shell
npm run typeorm migration:run
npm run typeorm entity:create -- -n bank-account
mv ./src/models/bank-accounts.ts ./src/models/bank-accounts.model.ts
```

- ./src/models/bank-account.model.ts
  - Configured bank_accounts entity

- ./src/app.module.ts
  - Adjusted AppModule

```shell
nest generate controller controllers/bank-account
```

- ./src/controllers/bank-account/bank-account.controller.ts
  - Adjusted BankAccountController class

- ./src/main.ts
  - Added global prefix

```shell
mkdir -p ./src/fixtures
touch ./src/fixtures/{fixtures,fixtures.command}.ts
```

- ./src/fixtures/fixtures.ts
  - Configured to test bank_accounts table

.
.
.

```shell
npm run typeorm migration:create -- -n CreatePixKeyTable
npm run typeorm migration:run
npm run typeorm entity:create -- -n pix-key
nest generate controller controllers/pix-key
npm install grpc @nestjs/microservices --save
npm install @grpc/proto-loader --save
npm install class-validator class-transformer --save
npm run typeorm migration:create -- -n CreateTransactionsTable
npm run typeorm migration:run
npm run typeorm entity:create -- -n transaction
nest generate controller controllers/transaction
npm install kafkajs --save
npm install commander nestjs-console --save
```

>>http://localhost:9021




git checkout -b aula3
docker rm $(docker ps -aq) -f
docker-compose up -d
docker-compose ps -a
docker exec -it codepix_app_1 bash
go run main.go
cobra add kafka
go run main.go kafka
mkdir -p ./application/{kafka,model,factory}
touch ./application/kafka/{producer,process}.go ./application/model/transaction.go ./application/factory/factory.go
```

- ./cmd/kafka.go
    - Generated by cobra add command
    - Imported os, application/kafka, infrastructure/db, confluent-kafka and cobra"
    - Adjusted variable kafkaCmd

- ./application/kafka/producer.go
    - Imported fmt, os and confluent-kafka
    - Created functions NewKafkaProducer, Publish and DeliveryReport

```browser
http://localhost:9021
    >> Added a new test topic
```

```shell
docker-compose ps -a
docker exec -it codepix_kafka_1 bash
kafka-topics --list --bootstrap-server=localhost:9092
kafka-console-consumer --topic=teste --bootstrap-server=localhost:9092
```

```shell
docker exec -it codepix_app_1 bash
go run main.go kafka
```

- ./application/factory/factory.go
    - Imported application/usecase, infrastructure/repository and gorm
    - Created function TransactionUseCaseFactory

- ./infrastructure/repository/transaction.go
    - Adjusted import gorm

- ./application/model/transaction.go
    - Imported encoding/json, fmt and validator
    - Created struct Transaction
    - Created methods isValid, ParseJson and ToJson
    - Created function NewTransaction

- ./application/kafka/process.go
    - Import fmt, application/factory, application/model, application/usecase, domain/model, confluent-kafka, gorm and os
    - Created struct KafkaProcessor
    - Created function NewKafkaProcessor
    - Created methods Consume, processMessage, processTransaction, processTransactionConfirmation and confirmTransaction

- .env
    - Added kafka environment variable

```shell
cobra add all
```

- ./cmd/all.go
    - Generated by cobra add command
    - Imported os, application/grpc, application/kafka, infrastructure/db, confluent-kafka and cobra
    - Adjusted variable allCmd and function init

```shell
go run main.go all
```
